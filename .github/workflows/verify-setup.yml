name: Verify Setup

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify-startup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Build customizations
      run: ./build.sh
      
    - name: Start services
      run: docker compose up -d
      
    - name: Wait for services to be healthy
      run: |
        echo "Waiting for services to be healthy..."
        timeout=300  # 5 minutes
        start_time=$(date +%s)
        
        while true; do
          current_time=$(date +%s)
          elapsed=$((current_time - start_time))
          
          if [ $elapsed -gt $timeout ]; then
            echo "❌ Services failed to become healthy within $timeout seconds"
            docker compose ps
            docker compose logs
            exit 1
          fi
          
          # Check if all services are running
          db_status=$(docker compose ps db --format "table {{.Status}}" | grep -v STATUS | grep -o "Up" || echo "Down")
          fhir_status=$(docker compose ps fhir --format "table {{.Status}}" | grep -v STATUS | grep -o "Up" || echo "Down")
          redirect_status=$(docker compose ps http-redirect --format "table {{.Status}}" | grep -v STATUS | grep -o "Up" || echo "Down")
          
          # For database, check if it's healthy
          db_health=$(docker compose ps db --format "table {{.Status}}" | grep -v STATUS | grep -o "healthy" || echo "starting")
          
          echo "Database: $db_health, FHIR: $fhir_status, HTTP-Redirect: $redirect_status (${elapsed}s elapsed)"
          
          # Services are ready when db is healthy and both fhir and redirect are up
          if [ "$db_health" = "healthy" ] && [ "$fhir_status" = "Up" ] && [ "$redirect_status" = "Up" ]; then
            echo "✅ All services are ready!"
            break
          fi
          
          sleep 10
        done
        
    - name: Verify FHIR metadata endpoint
      run: |
        echo "Testing FHIR metadata endpoint..."
        
        # Test HTTPS endpoint (with self-signed cert)
        echo "Testing HTTPS endpoint..."
        response=$(curl -k -s https://localhost:443/fhir/metadata)
        
        if echo "$response" | grep -q "CapabilityStatement"; then
          echo "✅ FHIR HTTPS server is responding correctly with CapabilityStatement"
        else
          echo "❌ FHIR HTTPS server response doesn't contain expected CapabilityStatement"
          echo "Response received:"
          echo "$response"
          exit 1
        fi
        
        # Test HTTP redirect (should get 301)
        echo "Testing HTTP redirect..."
        redirect_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/fhir/metadata)
        
        if [ "$redirect_code" = "301" ]; then
          echo "✅ HTTP redirect is working correctly (301 -> HTTPS)"
        else
          echo "❌ HTTP redirect failed, got code: $redirect_code"
          exit 1
        fi
        
    - name: Verify database connectivity
      run: |
        echo "Verifying database connectivity..."
        docker compose exec -T db psql -U admin -d hapi -c "SELECT version();" | head -1
        echo "✅ Database connection successful"
        
    - name: Show final service status
      run: |
        echo "Final service status:"
        docker compose ps
        
    - name: Cleanup
      if: always()
      run: |
        echo "Shutting down services..."
        docker compose down -v
        echo "✅ Cleanup completed"
