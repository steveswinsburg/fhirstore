name: Verify Setup

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify-startup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Start services
      run: docker compose up -d
      
    - name: Wait for services to be healthy
      run: |
        echo "Waiting for services to be healthy..."
        timeout=300  # 5 minutes
        start_time=$(date +%s)
        
        while true; do
          current_time=$(date +%s)
          elapsed=$((current_time - start_time))
          
          if [ $elapsed -gt $timeout ]; then
            echo "❌ Services failed to become healthy within $timeout seconds"
            docker compose ps
            docker compose logs
            exit 1
          fi
          
          # Check if both services are healthy
          db_health=$(docker compose ps db --format "table {{.Status}}" | grep -v STATUS | grep -o "healthy" || echo "unhealthy")
          fhir_health=$(docker compose ps fhir --format "table {{.Status}}" | grep -v STATUS | grep -o "healthy" || echo "unhealthy")
          
          echo "Database: $db_health, FHIR: $fhir_health (${elapsed}s elapsed)"
          
          if [ "$db_health" = "healthy" ] && [ "$fhir_health" = "healthy" ]; then
            echo "✅ All services are healthy!"
            break
          fi
          
          sleep 10
        done
        
    - name: Verify FHIR metadata endpoint
      run: |
        echo "Testing FHIR metadata endpoint..."
        response=$(curl -s http://localhost:8080/fhir/metadata)
        
        if echo "$response" | grep -q "CapabilityStatement"; then
          echo "✅ FHIR server is responding correctly with CapabilityStatement"
        else
          echo "❌ FHIR server response doesn't contain expected CapabilityStatement"
          echo "Response received:"
          echo "$response"
          exit 1
        fi
        
    - name: Verify database connectivity
      run: |
        echo "Verifying database connectivity..."
        docker compose exec -T db psql -U admin -d hapi -c "SELECT version();" | head -1
        echo "✅ Database connection successful"
        
    - name: Show final service status
      run: |
        echo "Final service status:"
        docker compose ps
        
    - name: Cleanup
      if: always()
      run: |
        echo "Shutting down services..."
        docker compose down -v
        echo "✅ Cleanup completed"
