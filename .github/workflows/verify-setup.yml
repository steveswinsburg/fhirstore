name: Verify Setup

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  verify-startup:
    runs-on: ubuntu-latest
    
    env:
      FHIR_PORT: 8080
      DB_USER: admin
      DB_NAME: hapi
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Start services
      run: docker compose up -d
      
    - name: Wait for FHIR server to be ready
      run: |
        echo "Waiting for FHIR server to start..."
        max_attempts=30
        attempt=0
        
        while [ $attempt -lt $max_attempts ]; do
          if curl -sf http://localhost:${{ env.FHIR_PORT }}/fhir/metadata > /dev/null 2>&1; then
            echo "FHIR server is ready!"
            exit 0
          fi
          attempt=$((attempt + 1))
          echo "Attempt $attempt/$max_attempts - FHIR server not ready yet, waiting..."
          sleep 10
        done
        
        echo "FHIR server failed to start within expected time"
        echo "Showing container logs:"
        docker compose logs
        exit 1
        
    - name: Verify FHIR metadata endpoint
      run: |
        echo "Testing FHIR metadata endpoint..."
        response=$(curl -s http://localhost:${{ env.FHIR_PORT }}/fhir/metadata)
        
        if echo "$response" | grep -q "CapabilityStatement"; then
          echo "✓ FHIR server is responding correctly"
          echo "Response preview:"
          echo "$response" | head -20
        else
          echo "✗ FHIR server response doesn't look correct"
          echo "Full response:"
          echo "$response"
          exit 1
        fi
        
    - name: Check database connection
      run: |
        echo "Checking database container..."
        docker compose exec -T db pg_isready -U ${{ env.DB_USER }} -d ${{ env.DB_NAME }}
        
    - name: Show service status
      if: always()
      run: docker compose ps
      
    - name: Show logs on failure
      if: failure()
      run: docker compose logs
      
    - name: Cleanup
      if: always()
      run: docker compose down -v
